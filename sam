#!/bin/bash
#set -vx
if [[ -z $DOCKER_PATH ]];then
        DOCKER_PATH='/usr/bin/docker';
fi;

if [[ -z $SAM_DB_LIST ]];then
        SAM_DB_LIST='/var/db/sam/list_installed';
fi;

if [[ -z $BIN_DIR ]]; then
        BIN_DIR='/opt/bin'
fi;

if [[ -z $SAM_DB_SQLITE ]];then
        SAM_DB_SQLITE='/var/db/sam/smilart.db';
fi;
##Constant

IMAGE='';

## Functions
# Copy META from image
copy_meta_func () {
	# input: $IMAGE $DOCKER_PATH
	TEMPLATE_DIR=`mktemp -d`;
	$DOCKER_PATH run -i -t --rm -v $TEMPLATE_DIR:$TEMPLATE_DIR  --net=host --entrypoint="cp" $IMAGE -r /meta $TEMPLATE_DIR/meta 2>&1 > /dev/null;
	if [[ $? -ne 0 ]]; then
		echo -e "\E[31mERROR: Directory '/meta' not found in image.">&2;tput sgr0;
		rm -rf $TEMPLATE_DIR;
		exit 1;
	fi;
	# output $pwd $TEMPLATE_DIR
}

# Uninstall image function
uninstall_image_func () {
	echo;	
	echo -e "\E[32mUninstalling image $IMAGE.";tput sgr0;
	copy_meta_func;
	pwd=$PWD;
	cd $TEMPLATE_DIR/meta;
	source $TEMPLATE_DIR/meta/uninstall;
	cd $pwd;
	rm -rf $TEMPLATE_DIR;
	echo;
}

# Install image function
install_image_func () {
	echo;
	echo -e "\E[32mInstalling image $IMAGE.";tput sgr0;
	copy_meta_func;
	pwd=$PWD;
	cd $TEMPLATE_DIR/meta;
	echo;
	source $TEMPLATE_DIR/meta/install;
	cd $pwd;
	rm -rf $TEMPLATE_DIR;
	echo;	
}

# Save image in db function
save_image_to_db_sqlite_func () {
	# Exist image in db?
	TEST_EXIST=`echo "$IMAGE" | awk -F ':' 'NF--' | sed "s/ /:/g"`
	if [[ -n `list_images_in_db_func | awk  'BEGIN {OFS = ":"} {print $3, $4}' | grep $TEST_EXIST` ]];then
		echo -e "\E[31mERROR: Image exist in db. ">&2;tput sgr0;
		echo "List exist images: ./sam -l"
		echo;
		exit 1;
	fi;
	echo  "Save image to db.";
	# Collecting info in image
	IMAGE_ID=`$DOCKER_PATH images | grep -v 'REPOSITORY' | awk -F ' ' ' {print $1,$2,$3} ' | sed "s/ /:/g" | grep "$IMAGE" | awk -F ':' '{print $NF}'`
	IMAGE_VERSION=`$DOCKER_PATH images | grep -v 'REPOSITORY' | awk -F ' ' ' {print $1,$2} ' | sed "s/ /:/g" | grep "$IMAGE" | awk -F ':' '{print $NF}'`
	IMAGE_NAME=`$DOCKER_PATH images | grep "$IMAGE_ID" | tail -1 | awk -F ' ' ' {print $1} '`;
	# Edit db
	sqlite3 $SAM_DB_SQLITE "insert into $SAM_DB_TABLE_INSTALL_IMAGES (DockerId,ImageName,ImageVersion) values ('$IMAGE_ID','$IMAGE_NAME','$IMAGE_VERSION');";
	unset TEST_EXIST;
	unset IMAGE_ID;
	unset IMAGE_VERSION;
	unset IMAGE_NAME;
}

# Delete image in db function
delete_image_to_db_func () {
	echo  "Deleting image name in db.";
	sqlite3 $SAM_DB_SQLITE "delete from $SAM_DB_TABLE_INSTALL_IMAGES where DockerId='$IMAGE'"	
	# Edit db
	
}

# Image latest?
image_latest_func (){
	VERSION_IMAGE=`echo "$IMAGE" | awk -F '/' '{print $NF}' | awk -F ':' '{print $2}'`;
	if [[ -z $VERSION_IMAGE ]];then
                IMAGE="$IMAGE:latest"
        fi;
}

create_connect_func() {
	echo "Creating 'connect' function."
	echo '#!/bin/bash 

connect_func(){
PID=`/usr/bin/docker inspect --format {{.State.Pid}} $1`;
if [ -z $PID ]; then
        echo -e "\E[31mContainer $1 is not found."; tput sgr0;
else
        if [ $PID -eq 0 ]; then
                echo -e "\E[31mContainer $1 is not started.";tput sgr0;
        else
                echo -e "\E[32mConnect to container $1."; tput sgr0;
                /usr/bin/docker exec -i -t $1 /bin/bash -c "cd /root ; TERM=xterm HOME=/root /bin/bash"
        fi;
fi;
}

connect_func $@;' > $BIN_DIR/connect;
	chmod +x $BIN_DIR/connect;
	if [[ -z `id smilart 2>&1 | grep 'no such user'` ]]; then
		chown smilart $BIN_DIR/connect;
	fi;
}

## Commands
# This root?
if [[ $EUID -ne 0 ]]; then
    echo -e "\E[31mThis script must be run as root">&2;tput sgr0;
    exit 1
fi

# Exist BIN_DIR dirrectory ?
if ! [[ -d $BIN_DIR ]]; then
        echo "Creating $BIN_DIR.";
        mkdir -p $BIN_DIR;
fi

# Exist BIN_DIR in path ?
TEST_PATH=`echo $PATH | grep $BIN_DIR`;
if [[ -z $TEST_PATH ]]; then
	echo -e "\E[31mERROR: Not found path \"$BIN_DIR\" in environments \$PATH. Add.">&2;tput sgr0;
	exit 1;
fi;

# Exist command 'connect'?
if ! [[ -f $BIN_DIR/connect ]]; then
        create_connect_func;
	echo;
fi;

# Exist command sqlite3
if [[ -z `which sqlite3` ]]; then
        echo -e "\E[31mERROR: Not found command sqlite3 in system.">&2;tput sgr0;
        exit 1;
fi;

# Exist db?
SAM_DB_TABLE_INSTALL_IMAGES="Images";
CREATE_DB="create table $SAM_DB_TABLE_INSTALL_IMAGES (id INTEGER PRIMARY KEY,DockerId TEXT,ImageName TEXT,ImageVersion TEXT);"
if [[ -z `sqlite3 $SAM_DB_SQLITE "SELECT name FROM sqlite_master WHERE type='table' AND name='$SAM_DB_TABLE_INSTALL_IMAGES'"` ]];then
        echo;
        echo "Not found db sam: $SAM_DB_SQLITE. Creating list."
	echo;
        sqlite3 $SAM_DB_SQLITE $CREATE_DB;
fi;

#List images in SQLite db
list_images_in_db_func () {
	sqlite3 $SAM_DB_SQLITE "SELECT * from $SAM_DB_TABLE_INSTALL_IMAGES" | awk -F '|' '{print $1, $2, $3, $4}'
}

USAGE="
Options:
	-f  [archive.tar]	Load image from tar archive
	-i  [image]:[version]	Install selected docker image
	-u  [image]:[version]	Uninstall selected container
	-x  [-f:-i:-u] 		Debug mode
	-I  [image]:[version]	Print image info
	-c  [image]:[version]	Copy metadata from image to directory /tmp
	-l  			List installed image
	-L  [image]		List image versions from Docker Hub
	-h           		Help

Environments:
	DOCKER_PATH		Path docker, default: DOCKER_PATH=$DOCKER_PATH
	SAM_DB_LIST		SAM database, default: SAM_DB_LIST=$SAM_DB_LIST
	BIN_DIR			Path to directory with executable files, default: BIN_DIR=$BIN_DIR	
";

while getopts "L:li:f:u:c:xI:h" OPTION
do
    case $OPTION in

	l ) echo;
	    echo "      List images:";
            echo;
	    list_images_in_db_func | awk 'BEGIN {OFS = ":"} {print $3, $4}'
            echo;
	    exit 0
          ;;

	L ) ping -c 1 -n -q registry.hub.docker.com > /dev/null;
	    if [ $? -ne "0" ]; then
		echo -e "\E[31mERROR: Host registry.hub.docker.com is unknown.">&2;tput sgr0;
		exit 1;
	    fi;
	    LIST_VERSIONS=`curl "https://registry.hub.docker.com//v1/repositories/$OPTARG/tags" -f -s | sed 's/,/,\n/g' | grep name | awk -F '"' '{print $4}'`
	    if [ $? -ne "0" ]; then
                echo -e "\E[31mERROR: Image name is unknown.">&2;tput sgr0;
                exit 1;
	    else
		echo;
		echo "      List versions:";
		echo;
		echo "$LIST_VERSIONS" | sed 's/ /\n/g' | sed -e 's#^#'"$OPTARG"':#g';
		echo;
            fi;
	    exit 0
	  ;;

	x ) set -vx
	  ;;

        f ) if [ -f $OPTARG ]; then

                ## Find image name to archive
		# Find file "repositories"
		tar -xf $OPTARG repositories;
		if [[ $? -ne 0 ]]; then
		    echo -e "\E[31mERROR: File repositories not found in archive.">&2;tput sgr0;
		    echo "May be incorrectly created archive.";
		    exit 1;
		fi;
		# Correct file "repositories"
                IMAGE=`cat repositories | awk -F '"' ' {print $2,$4} ' | sed "s/ /:/g"`;
		if [[ -z $IMAGE ]]; then
		    echo -e "\E[31mERROR: Incorrect file 'repositories' in archive.">&2;tput sgr0;
		    echo "Not found image name in file.";
		    echo "May be incorrectly created archive.";
		    exit 1;[<32;1;38M
		fi;
		rm -f repositories;
		##
		if [[ -z `list_images_in_db_func | awk 'BEGIN {OFS = ":"} {print $3, $4}' | grep "$IMAGE"` ]];then
                	echo "Image not found in db."
			# Load image
			echo "Loading image $IMAGE."
			$DOCKER_PATH load -i $OPTARG
			if [[ $? -ne 0 ]]; then	
			    echo -e "\E[31mERROR: Loading image.">&2;tput sgr0;
			    exit 1;
			fi;
			# Install image
			save_image_to_db_sqlite_func;
#			save_image_to_list_db_func;
			install_image_func;
			echo -e "\E[32mImage $IMAGE installed.";tput sgr0;
			echo;
		else 
			echo -e "\E[31mERROR: Image exist in db.">&2;tput sgr0;
			exit 1;
	   	fi;
	   else
		echo -e "\E[31m$0: Archive image is not defined." >&2;tput sgr0;
		exit 1;
	   fi
	  ;;

	i ) IMAGE=$OPTARG;
	   image_latest_func;
	   # Installed image?	   
	   if [[ -n `list_images_in_db_func | awk 'BEGIN {OFS = ":"} {print $3, $4}' | grep "$IMAGE"` ]];then
		echo -e "\E[31mERROR: Image found in db. Stop installation.">&2;tput sgr0;
		exit 1;
	   fi;
	   # Exist image?
	   TEST_IMAGE=`$DOCKER_PATH images | grep -v 'REPOSITORY' | awk -F ' ' ' {print $1,$2} ' | sed "s/ /:/g" | grep "$IMAGE"`;
	   if [[ -z $TEST_IMAGE ]];then
                echo -e "\E[31mERROR: Image not found in registry docker. Stop installation.">&2;tput sgr0;
                exit 1;
           fi;
	   # Install image
           save_image_to_db_sqlite_func;
	   install_image_func;
	   echo -e "\E[32mImage $IMAGE installed.";tput sgr0;
	   echo;
	   exit 0
	  ;;
	
	u ) IMAGE=$OPTARG;
           image_latest_func;
	   # Installed image?
           if [[ -z `list_images_in_db_func | awk 'BEGIN {OFS = ":"} {print $3, $4}' | grep "$IMAGE"` ]];then
                echo -e "\E[31mERROR: Image not found in db.">&2;tput sgr0;
                exit 1;
	   else
		IMAGE=`$DOCKER_PATH images | grep -v 'REPOSITORY' | awk -F ' ' ' {print $1,$2,$3} ' | sed "s/ /:/g" | grep "$IMAGE" | awk -F ':' '{print $NF}'`
           fi;
           # Exist image?  
           TEST_IMAGE=`$DOCKER_PATH images | grep -v 'REPOSITORY' | awk -F ' ' ' {print $3} ' | grep "$IMAGE"`;
           if [[ -z $TEST_IMAGE ]];then
                echo -e "\E[31mERROR: Image not found in registry docker.">&2;tput sgr0;
                exit 1;
           fi;
	   # Uninstall image
	   uninstall_image_func;
	   delete_image_to_db_func;
           echo -e "\E[32mImage $IMAGE uninstalled.";tput sgr0;
           exit 0
	  ;;
        c ) IMAGE=$OPTARG;
	    image_latest_func;
	    # Exist image?
            TEST_IMAGE=`$DOCKER_PATH images | grep -v 'REPOSITORY' | awk -F ' ' ' {print $1,$2} ' | sed "s/ /:/g" | grep "$IMAGE"`;
            if [[ -z $TEST_IMAGE ]];then
                echo -e "\E[31mERROR: Image not found in registry docker. Stop installation.">&2;tput sgr0;
                exit 1;
            fi;
	    copy_meta_func;
            pwd=$PWD;
	    IMAGE=`echo $IMAGE | sed "s/\//./g"`
	    echo;
	    # Remove exist dirrectory
	    if [[ -d /tmp/meta_$IMAGE ]];then
		echo "Removing old dirrectory."
                rm -r /tmp/meta_$IMAGE;
            fi;
	    mv $TEMPLATE_DIR/meta /tmp/meta_$IMAGE
	    cd $pwd;
	    rm -r $TEMPLATE_DIR;
	    echo "Meta files are moved to a folder /tmp/meta_$IMAGE"
	    echo;
	    exit 0
	   ;;
	    

	I ) IMAGE=$OPTARG;
	    image_latest_func;
	    copy_meta_func;
	    pwd=$PWD;
            cd $TEMPLATE_DIR/meta;
            echo;
	    cat DESCRIPTION;
	    echo;
	    echo "    Time of creation:"
	    cat BUILDSTAMP; 
            cd $pwd;
            rm -rf $TEMPLATE_DIR;
            echo;
	    exit 0
	  ;;

        h ) echo "$USAGE"; 
	    exit 0
          ;;

        *) echo
	  ;;
    esac
done

if [[ -z $IMAGE ]];then 
	IMAGE=$1;
	image_latest_func;
	if [[ -n `list_images_in_db_func | awk 'BEGIN {OFS = ":"} {print $3, $4}' | grep "$IMAGE"` ]];then
            echo -e "\E[31mERROR: Image found in db. Stop installation.">&2;tput sgr0;
            exit 1;
        fi;
	# Pull
	$DOCKER_PATH pull $IMAGE;
	if [[ $? -eq 0 ]]; then
		save_image_to_db_sqlite_func;
		install_image_func;
		echo -e "\E[32mImage $IMAGE installed.";tput sgr0;
		echo;
	else
        	echo -e "\E[31mNot found image \"$1\"." >&2;tput sgr0;
		exit 1;
	fi;
fi;
